<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Search & Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div id="app"></div>

    <script>
        class SearchQuizApp {
            constructor() {
                this.apiKey = '';
                this.isApiKeySet = false;
                this.searchQuery = '';
                this.searchResults = null;
                this.searchHistory = [];
                this.activeTab = 'search';
                this.selectedQuiz = null;
                this.userAnswer = null;
                this.showExplanation = false;
                this.expandedResults = {};
                
                this.init();
            }

            init() {
                const savedKey = localStorage.getItem('gemini_api_key');
                const savedHistory = localStorage.getItem('search_history');
                
                if (savedKey) {
                    this.apiKey = savedKey;
                    this.isApiKeySet = true;
                }
                
                if (savedHistory) {
                    this.searchHistory = JSON.parse(savedHistory);
                }
                
                this.render();
            }

            saveApiKey() {
                const input = document.getElementById('apiKeyInput');
                if (input.value.trim()) {
                    this.apiKey = input.value.trim();
                    localStorage.setItem('gemini_api_key', this.apiKey);
                    this.isApiKeySet = true;
                    this.render();
                }
            }

            clearApiKey() {
                if (confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('gemini_api_key');
                    this.apiKey = '';
                    this.isApiKeySet = false;
                    this.render();
                }
            }

            async performSearch() {
                const input = document.getElementById('searchInput');
                this.searchQuery = input.value.trim();
                
                if (!this.searchQuery || !this.isApiKeySet) return;

                const searchBtn = document.getElementById('searchBtn');
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<span class="animate-spin">ğŸ”„</span> æ¤œç´¢ä¸­...';

                try {
                    const searchPrompt = `ä»¥ä¸‹ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã€Webæ¤œç´¢ã‚’è¡Œã„ã€æ¤œç´¢çµæœã‚’300æ–‡å­—ä»¥å†…ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€æ¤œç´¢çµæœã®å…¨æ–‡ã‚‚æä¾›ã—ã¦ãã ã•ã„ã€‚

æ¤œç´¢ã‚¯ã‚¨ãƒª: ${this.searchQuery}

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "summary": "300æ–‡å­—ä»¥å†…ã®è¦ç´„",
  "fullText": "æ¤œç´¢çµæœã®å…¨æ–‡(ã§ãã‚‹ã ã‘è©³ç´°ã«)"
}`;

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: searchPrompt }] }]
                            })
                        }
                    );

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    
                    let parsedResult;
                    try {
                        const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                        parsedResult = jsonMatch ? JSON.parse(jsonMatch[0]) : {
                            summary: resultText.substring(0, 300),
                            fullText: resultText
                        };
                    } catch {
                        parsedResult = {
                            summary: resultText.substring(0, 300),
                            fullText: resultText
                        };
                    }

                    const quizPrompt = `ä»¥ä¸‹ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã¨æ¤œç´¢çµæœã‹ã‚‰ã€4æŠã‚¯ã‚¤ã‚ºã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

æ¤œç´¢ã‚¯ã‚¨ãƒª: ${this.searchQuery}
æ¤œç´¢çµæœ: ${parsedResult.summary}

é‡è¦ãªåˆ¶ç´„:
1. å•é¡Œæ–‡ã§ã¯æ¤œç´¢ã‚¯ã‚¨ãƒªã€Œ${this.searchQuery}ã€ã‚’60æ–‡å­—ç¨‹åº¦ã§èª¬æ˜ã™ã‚‹æ–‡ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„
2. å•é¡Œæ–‡ã«ã€Œ${this.searchQuery}ã€ã¨ã„ã†å˜èªã‚’çµ¶å¯¾ã«å«ã‚ãªã„ã§ãã ã•ã„
3. æ­£è§£ã¯æ¤œç´¢ã‚¯ã‚¨ãƒªã€Œ${this.searchQuery}ã€ã¨ã—ã€ä»–ã®3ã¤ã¯é–¢é€£ã™ã‚‹ãŒé–“é•ã£ãŸé¸æŠè‚¢ã«ã—ã¦ãã ã•ã„
4. è§£èª¬ã¯æ¤œç´¢çµæœã«åŸºã¥ã„ã¦æ•™è‚²çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„å†…å®¹ã«ã—ã¦ãã ã•ã„

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "question": "æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’èª¬æ˜ã™ã‚‹å•é¡Œæ–‡(60æ–‡å­—ç¨‹åº¦ã€æ¤œç´¢ã‚¯ã‚¨ãƒªã®å˜èªã‚’å«ã¾ãªã„)",
  "options": ["${this.searchQuery}", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
  "correctAnswer": 0,
  "explanation": "è§£èª¬æ–‡"
}`;

                    const quizResponse = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: quizPrompt }] }]
                            })
                        }
                    );

                    const quizData = await quizResponse.json();
                    const quizText = quizData.candidates[0].content.parts[0].text;
                    
                    let quiz;
                    try {
                        const quizJsonMatch = quizText.match(/\{[\s\S]*\}/);
                        quiz = quizJsonMatch ? JSON.parse(quizJsonMatch[0]) : null;
                    } catch {
                        quiz = null;
                    }

                    const newResult = {
                        id: Date.now(),
                        query: this.searchQuery,
                        summary: parsedResult.summary,
                        fullText: parsedResult.fullText,
                        quiz: quiz,
                        timestamp: new Date().toISOString()
                    };

                    this.searchResults = newResult;
                    this.searchHistory.unshift(newResult);
                    localStorage.setItem('search_history', JSON.stringify(this.searchHistory));
                    
                    this.render();
                } catch (error) {
                    alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = 'ğŸ” æ¤œç´¢';
                }
            }

            clearHistory() {
                if (confirm('æ¤œç´¢å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.searchHistory = [];
                    localStorage.removeItem('search_history');
                    this.render();
                }
            }

            toggleExpand(id) {
                this.expandedResults[id] = !this.expandedResults[id];
                this.render();
            }

            selectQuiz(item) {
                this.selectedQuiz = item;
                this.userAnswer = null;
                this.showExplanation = false;
                this.render();
            }

            submitAnswer(index) {
                if (!this.showExplanation) {
                    this.userAnswer = index;
                    this.showExplanation = true;
                    this.render();
                }
            }

            render() {
                const app = document.getElementById('app');
                
                if (!this.isApiKeySet) {
                    app.innerHTML = this.renderApiKeyScreen();
                } else {
                    app.innerHTML = this.renderMainScreen();
                }
                
                this.attachEventListeners();
            }

            renderApiKeyScreen() {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full fade-in">
                            <div class="flex items-center justify-center mb-6">
                                <div class="w-12 h-12 text-4xl">ğŸ”‘</div>
                            </div>
                            <h1 class="text-2xl font-bold text-center mb-2 text-gray-800">
                                AI Search & Quiz
                            </h1>
                            <p class="text-center text-gray-600 mb-6">
                                Google AI Studio APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                            </p>
                            <input
                                id="apiKeyInput"
                                type="password"
                                placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none mb-4"
                            />
                            <button
                                onclick="app.saveApiKey()"
                                class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition"
                            >
                                é–‹å§‹
                            </button>
                            <p class="text-xs text-gray-500 mt-4 text-center">
                                APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™
                            </p>
                        </div>
                    </div>
                `;
            }

            renderMainScreen() {
                return `
                    <div class="max-w-6xl mx-auto p-4">
                        <header class="bg-white rounded-2xl shadow-lg p-6 mb-6 fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    AI Search & Quiz
                                </h1>
                                <button
                                    onclick="app.clearApiKey()"
                                    class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1"
                                >
                                    ğŸ”‘ APIã‚­ãƒ¼å‰Šé™¤
                                </button>
                            </div>
                            ${this.activeTab === 'search' ? `
                                <div class="flex gap-2">
                                    <input
                                        id="searchInput"
                                        type="text"
                                        placeholder="æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›..."
                                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                        onkeypress="if(event.key==='Enter') app.performSearch()"
                                    />
                                    <button
                                        id="searchBtn"
                                        onclick="app.performSearch()"
                                        class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition"
                                    >
                                        ğŸ” æ¤œç´¢
                                    </button>
                                </div>
                            ` : ''}
                        </header>

                        <div class="flex gap-2 mb-6">
                            <button
                                onclick="app.activeTab='search'; app.render()"
                                class="flex-1 py-3 rounded-lg font-semibold transition ${
                                    this.activeTab === 'search'
                                        ? 'bg-purple-600 text-white'
                                        : 'bg-white text-gray-600 hover:bg-gray-50'
                                }"
                            >
                                ğŸ” æ¤œç´¢
                            </button>
                            <button
                                onclick="app.activeTab='history'; app.render()"
                                class="flex-1 py-3 rounded-lg font-semibold transition ${
                                    this.activeTab === 'history'
                                        ? 'bg-purple-600 text-white'
                                        : 'bg-white text-gray-600 hover:bg-gray-50'
                                }"
                            >
                                ğŸ“œ å±¥æ­´
                            </button>
                            <button
                                onclick="app.activeTab='quiz'; app.render()"
                                class="flex-1 py-3 rounded-lg font-semibold transition ${
                                    this.activeTab === 'quiz'
                                        ? 'bg-purple-600 text-white'
                                        : 'bg-white text-gray-600 hover:bg-gray-50'
                                }"
                            >
                                ğŸ“š ã‚¯ã‚¤ã‚º
                            </button>
                        </div>

                        ${this.renderTabContent()}
                    </div>
                `;
            }

            renderTabContent() {
                if (this.activeTab === 'search') {
                    return this.renderSearchTab();
                } else if (this.activeTab === 'history') {
                    return this.renderHistoryTab();
                } else {
                    return this.renderQuizTab();
                }
            }

            renderSearchTab() {
                if (!this.searchResults) return '';
                
                return `
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">æ¤œç´¢çµæœ</h2>
                        <div class="mb-4">
                            <h3 class="font-semibold text-purple-600 mb-2">æ¤œç´¢ã‚¯ã‚¨ãƒª:</h3>
                            <p class="text-gray-700">${this.searchResults.query}</p>
                        </div>
                        <div class="mb-4">
                            <h3 class="font-semibold text-purple-600 mb-2">è¦ç´„ (300æ–‡å­—ä»¥å†…):</h3>
                            <p class="text-gray-700 leading-relaxed">${this.searchResults.summary}</p>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-purple-600">å…¨æ–‡:</h3>
                                <button
                                    onclick="app.toggleExpand(${this.searchResults.id})"
                                    class="text-purple-600 hover:text-purple-700 text-sm"
                                >
                                    ${this.expandedResults[this.searchResults.id] ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ å±•é–‹'}
                                </button>
                            </div>
                            ${this.expandedResults[this.searchResults.id] ? `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${this.searchResults.fullText}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderHistoryTab() {
                if (this.searchHistory.length === 0) {
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">æ¤œç´¢å±¥æ­´</h2>
                            <p class="text-gray-500 text-center py-8">æ¤œç´¢å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">æ¤œç´¢å±¥æ­´</h2>
                            <button
                                onclick="app.clearHistory()"
                                class="text-red-500 hover:text-red-700 text-sm"
                            >
                                ğŸ—‘ï¸ å…¨å‰Šé™¤
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${this.searchHistory.map(item => `
                                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-300 transition">
                                    <div class="flex items-start justify-between mb-2">
                                        <h3 class="font-semibold text-gray-800">${item.query}</h3>
                                        <span class="text-xs text-gray-500">
                                            ${new Date(item.timestamp).toLocaleString('ja-JP')}
                                        </span>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-2">${item.summary.substring(0, 100)}...</p>
                                    <button
                                        onclick="app.toggleExpand(${item.id})"
                                        class="text-purple-600 hover:text-purple-700 text-sm"
                                    >
                                        ${this.expandedResults[item.id] ? 'â–² é–‰ã˜ã‚‹' : 'â–¼ å…¨æ–‡ã‚’è¦‹ã‚‹'}
                                    </button>
                                    ${this.expandedResults[item.id] ? `
                                        <div class="mt-3 bg-gray-50 p-3 rounded-lg">
                                            <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">${item.fullText}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderQuizTab() {
                const quizHistory = this.searchHistory.filter(item => item.quiz);
                
                if (quizHistory.length === 0) {
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">ã‚¯ã‚¤ã‚º</h2>
                            <p class="text-gray-500 text-center py-8">
                                ã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢ã‚’è¡Œã†ã¨ã‚¯ã‚¤ã‚ºãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
                            </p>
                        </div>
                    `;
                }

                if (!this.selectedQuiz) {
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">ã‚¯ã‚¤ã‚º</h2>
                            <div class="space-y-3">
                                ${quizHistory.map(item => `
                                    <button
                                        onclick='app.selectQuiz(${JSON.stringify(item).replace(/'/g, "\\'")})'
                                        class="w-full text-left border-2 border-gray-200 rounded-lg p-4 hover:border-purple-300 transition"
                                    >
                                        <h3 class="font-semibold text-gray-800 mb-1">${item.query}</h3>
                                        <p class="text-sm text-gray-600">
                                            ${new Date(item.timestamp).toLocaleString('ja-JP')}
                                        </p>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                const quiz = this.selectedQuiz.quiz;
                return `
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <button
                            onclick="app.selectedQuiz=null; app.render()"
                            class="text-purple-600 hover:text-purple-700 mb-4 text-sm"
                        >
                            â† ã‚¯ã‚¤ã‚ºä¸€è¦§ã«æˆ»ã‚‹
                        </button>
                        <div class="bg-purple-50 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                                ${quiz.question}
                            </h3>
                            <div class="space-y-3">
                                ${quiz.options.map((option, index) => `
                                    <button
                                        onclick="app.submitAnswer(${index})"
                                        ${this.showExplanation ? 'disabled' : ''}
                                        class="w-full text-left p-4 rounded-lg border-2 transition ${
                                            this.showExplanation
                                                ? index === quiz.correctAnswer
                                                    ? 'border-green-500 bg-green-50'
                                                    : index === this.userAnswer
                                                    ? 'border-red-500 bg-red-50'
                                                    : 'border-gray-200 bg-gray-50'
                                                : 'border-gray-200 hover:border-purple-300 bg-white cursor-pointer'
                                        }"
                                    >
                                        <span class="font-semibold mr-2">${String.fromCharCode(65 + index)}.</span>
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        ${this.showExplanation ? `
                            <div class="rounded-lg p-6 ${
                                this.userAnswer === quiz.correctAnswer
                                    ? 'bg-green-50 border-2 border-green-200'
                                    : 'bg-red-50 border-2 border-red-200'
                            }">
                                <h4 class="font-bold text-lg mb-2">
                                    ${this.userAnswer === quiz.correctAnswer ? 'âœ… æ­£è§£!' : 'âŒ ä¸æ­£è§£'}
                                </h4>
                                <p class="text-gray-700 mb-2">
                                    <strong>æ­£è§£:</strong> ${quiz.options[quiz.correctAnswer]}
                                </p>
                                <div class="bg-white rounded-lg p-4 mt-4">
                                    <h5 class="font-semibold mb-2 text-purple-600">è§£èª¬:</h5>
                                    <p class="text-gray-700 leading-relaxed">
                                        ${quiz.explanation}
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            attachEventListeners() {
                // Enter key support for API key input
                const apiKeyInput = document.getElementById('apiKeyInput');
                if (apiKeyInput) {
                    apiKeyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.saveApiKey();
                    });
                }
            }
        }

        const app = new SearchQuizApp();
    </script>
</body>
</html>
